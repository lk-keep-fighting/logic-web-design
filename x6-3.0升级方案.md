# X6 3.0 升级方案

> 依据官方《[升级到 3.x 版本 | X6 图编辑引擎][1]》整理的项目升级路线，用于指导后续代码改造。

## 背景
- 当前工程运行在 React 18 + Umi 4 + AntV X6 2.x 生态，核心价值是逻辑编排及调试工具。
- 代码里大量依赖 `@antv/x6` 及 11 个独立插件包（Selection、Transform、Scroller 等），并在多个页面/组件中初始化 Graph。
- 官方在 3.x 中合并插件、调整交互默认值并新增动画能力，升级可以减少依赖数量、获得后续特性，同时需要显式处理新的默认行为以避免交互回归。

## 官方变更要点（摘自文档）
1. **插件合并**：`@antv/x6-plugin-xxxx` 全部整合进 `@antv/x6` 主包并统一导出，package.json 仅需 `@antv/x6@^3.0.0`。[1]
2. **导入路径变更**：所有插件类（`Scroller`、`Selection` 等）直接从 `@antv/x6` 导入，业务调用方式（`graph.use(new Xxx())`）保持不变。[1]
3. **新增动画能力**：3.x 引入 `graph.animate` 等动画 API，移除 2.x 的 `transition` 用法。[1]
4. **配置默认值调整**：
   - 画布 `panning` 默认开启；
   - `Selection` 与 `panning` 冲突时，框选优先；
   - 启用 `Scroller` 时，默认关闭 `panning` 并支持虚拟渲染 `virtual: true`。[1]

## 现状梳理
### 依赖现状
| 包名 | 当前版本 | 用途/备注 |
| --- | --- | --- |
| `@antv/x6` | ^2.18.1 | 核心图引擎 |
| `@antv/x6-react-shape` | ^2.1.2 | React 自定义节点注册，需要确认 3.x 兼容版本 |
| `@antv/x6-plugin-clipboard` | ^2.1.6 | 复制粘贴 |
| `@antv/x6-plugin-dnd` | ^2.0.5 | 自定义节点面板拖拽 |
| `@antv/x6-plugin-export` | ^2.1.6 | 导出图片 |
| `@antv/x6-plugin-history` | ^2.2.2 | 撤销/重做 |
| `@antv/x6-plugin-keyboard` | ^2.2.1 | 快捷键 |
| `@antv/x6-plugin-minimap` | ^2.0.6 | 小地图 |
| `@antv/x6-plugin-scroller` | ^2.0.10 | 画布滚动/虚拟化 |
| `@antv/x6-plugin-selection` | ^2.1.7 | 框选 |
| `@antv/x6-plugin-snapline` | ^2.1.7 | 对齐辅助线 |
| `@antv/x6-plugin-stencil` | ^2.0.3 | 左侧节点面板 |
| `@antv/x6-plugin-transform` | ^2.1.8 | 节点缩放/拖拽 |

### 代码使用范围
| 场景/模块 | 主要文件 | 说明（涉及插件） |
| --- | --- | --- |
| Logic 可视化编排器（本地） | `src/components/x6-graph/index.tsx` | 使用 Selection/Transform/Clipboard/History/Keyboard/Snapline/Stencil/Scroller/MiniMap/Export，自定义 React shape (`InitGraph.ts`) |
| Logic Editor（通用组件） | `src/components/logic-editor/editor/index.tsx`、`panel/custom-node-panel/index.tsx` | 除上表插件外，还包含 Dnd + Stencil 协同的节点面板 |
| 运行调试图谱查看 | `src/pages/logic-flow/biz/components/debugLog/index.tsx` | 只读图，使用 Selection/Snapline/History/Scroller/Keyboard |
| 历史调试日志查看 | `src/pages/logic-flow/biz/components/debugLogicLog/index.tsx` | 同上 |
| 自定义节点注册 | `src/components/x6-graph/settings/InitGraph.ts`、`src/pages/logic-flow/biz/settings/RegistExtShape.ts` | 调用 `Graph.registerNode` + `@antv/x6-react-shape.register` |

## 升级策略与实施步骤
### 1. 依赖调整
1. 在 `package.json` 中将 `@antv/x6` 升级到 `^3.0.0`，删除所有 `@antv/x6-plugin-*` 依赖，只保留需要的主包及 `@antv/x6-react-shape`。
2. 检查 `@antv/x6-react-shape` 的最新版本（需支持 X6 3.x），如有 3.x 对应版本则一并升级；否则锁定当前版本并验证兼容性。
3. 执行 `pnpm install` 重新生成 `pnpm-lock.yaml`，确保没有遗留的插件依赖。

### 2. 代码改造
#### 2.1 插件导入统一
- 将所有 `import { Xxx } from '@antv/x6-plugin-***'` 改为 `import { Xxx } from '@antv/x6'`。
- 涉及文件：`x6-graph/index.tsx`、`logic-editor/editor/index.tsx`、`logic-editor/panel/custom-node-panel/index.tsx`、`debugLog/index.tsx`、`debugLogicLog/index.tsx` 等。
- TypeScript 类型无需改动，`@antv/x6` 3.x 会同时导出插件类定义。

#### 2.2 交互配置对齐
- **Panning**：目前各 Graph 都未显式开启 panning（2.x 默认关闭）。在 3.x 中需要按场景确认：
  - 编辑器场景若仍希望通过空白区域框选而非拖拽画布，应在 Graph 配置中明确 `panning: false`；
  - 若需要拖动画布，则可以保留默认值或根据业务改成 `panning: { enabled: true, modifiers: 'shift' }` 等组合。
- **Scroller 虚拟渲染**：3.x 的 `Scroller` 默认会关闭画布 panning 并开启 `virtual: true`，需要评估：
  - 若仍需与当前行为一致，可在 `.use(new Scroller({ enabled: true, virtual: false }))` 中关闭虚拟化；
  - 若接受虚拟化，则需验证拖拽和节点渲染是否有延迟或尺寸计算问题。
- **Selection 优先级**：由于 3.x 中框选优先级提高，需验证与自定义 `pointerEvents: 'none'` 等配置是否兼容，如发现冲突可在 Selection 配置中通过 `rubberband: true/false` 细化行为。

#### 2.3 业务模块专项检查
- **逻辑编排器**：
  - 导入更新后，确认 Clipboard/History/Keyboard/Transform 等插件仍能正常启用；
  - `Export` 功能依赖 `graph.use(new Export())`，需确认 3.x 中 API 是否有额外参数（若要导出 PNG/SVG 可参考官方示例）。
- **自定义节点面板**：`Stencil` 与 `Dnd` 在 3.x 改为主包导出，注意 panel 初始化顺序（先注册 Stencil，再绑定 Dnd 拖拽）。
- **调试/查看页面**：这两个页面只读，重点验证 `graph.fromJSON`、`autoDagreLayout` 以及 `Selection` 框选行为是否受默认 panning 影响。
- **React Shape**：升级后重新验证 `InitPanelData` 中注册的 React 节点在编辑器与调试页均能渲染（尤其是挂在 `@antv/x6-react-shape` 的 `register`）。

#### 2.4 动画能力排查
- 工程内未使用旧版 `transition` API（代码搜索已确认），因此无需迁移。若后续需要动画，可以增量采用新 `animate` 能力。

### 3. 验证计划
1. **基础功能**：
   - 节点拖入/拖出、连线、移动、缩放、复制粘贴、快捷键、撤销/重做、导出图片、小地图等。
2. **调试相关**：
   - Debug Log/Logic Log 页面加载历史拓扑，确认布局 & 节点高亮无异常。
3. **交互手势**：
   - 验证 panning、框选、自定义空白区域操作，重点关注 `Scroller` + Selection 的组合。
4. **性能**：
   - 大图场景下测试滚动性能，必要时开启/关闭 `Scroller.virtual` 做对比。
5. **兼容性**：
   - 检查 `@antv/x6-react-shape` 节点在各页面渲染，确保没有类型冲突或报错。

### 4. 风险与回滚
- **风险点**：交互默认值变化导致用户手势改变；插件导入路径遗漏导致运行时报错；`@antv/x6-react-shape` 版本不兼容。
- **缓解措施**：
  - 在 PR 中逐文件检查导入；
  - 显式配置 `panning`、`Scroller.virtual` 等关键项；
  - 若发现 React Shape 不兼容，可暂时锁定 2.x，并在升级记录中说明。
- **回滚方案**：保留升级前的 `pnpm-lock.yaml` 与 `package.json` 版本标签，如线上异常可快速切回 2.x 分支；同时准备差异化配置方便重新升级。

## 结论
按照上述步骤先完成依赖与导入改造，再聚焦交互行为验证即可完成 X6 3.0 升级的准备工作。后续开发可在此方案基础上逐条执行并记录验证结果。

[1]: https://x6.antv.antgroup.com/tutorial/update
